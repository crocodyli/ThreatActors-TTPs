name: Sync MITRE APT Data

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  sync-mitre-apts:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Fetch MITRE data
        run: curl -o enterprise-attack.json https://raw.githubusercontent.com/mitre/cti/master/enterprise-attack/enterprise-attack.json

      - name: Sync MITRE APT groups
        run: |
          python3 - << 'ENDOFPYTHON'
          import json
          import re
          from pathlib import Path
          from datetime import datetime

          def clean_markdown_table(raw_content, group_name, section_name):
              lines = raw_content.split('\n')
              table_rows = []
              for line in lines:
                  line = line.strip()
                  if not line or line.startswith('#') or line.startswith('*'):
                      continue
                  if 'auto-generated' in line.lower():
                      continue
                  if line.startswith('|'):
                      if all(c in '|-: ' for c in line):
                          continue
                      if 'Technique' in line and 'Name' in line and 'Source' in line:
                          continue
                      table_rows.append(line)
              
              header = f"# {group_name} - {section_name}\n\n"
              header += "| Technique | Name | Source | Date |\n"
              header += "|-----------|------|--------|------|\n"
              return header + '\n'.join(table_rows) + '\n' if table_rows else header

          print("=" * 80)
          print("MITRE APT Data Sync")
          print("=" * 80)

          with open('enterprise-attack.json', 'r') as f:
              mitre_data = json.load(f)

          apt_groups = {}
          technique_map = {}
          software_map = {}

          for obj in mitre_data['objects']:
              if obj['type'] == 'attack-pattern':
                  for ref in obj.get('external_references', []):
                      if ref.get('source_name') == 'mitre-attack':
                          technique_id = ref.get('external_id')
                          if technique_id:
                              technique_map[obj['id']] = {
                                  'id': technique_id,
                                  'name': obj.get('name', ''),
                                  'description': obj.get('description', '')
                              }

          for obj in mitre_data['objects']:
              if obj['type'] in ['malware', 'tool']:
                  software_name = obj.get('name')
                  if software_name:
                      cves = set()
                      desc = obj.get('description', '')
                      cve_matches = re.findall(r'CVE-\d{4}-\d+', desc)
                      cves.update(cve_matches)
                      for ref in obj.get('external_references', []):
                          if 'cve' in ref.get('source_name', '').lower():
                              ext_id = ref.get('external_id', '')
                              if ext_id.startswith('CVE-'):
                                  cves.add(ext_id)
                      if cves:
                          software_map[obj['id']] = {
                              'name': software_name,
                              'cves': list(cves)
                          }

          for obj in mitre_data['objects']:
              if obj['type'] == 'intrusion-set':
                  group_name = obj.get('name')
                  if group_name:
                      apt_groups[obj['id']] = {
                          'name': group_name,
                          'aliases': obj.get('aliases', []),
                          'description': obj.get('description', ''),
                          'techniques': [],
                          'cves': set()
                      }

          for obj in mitre_data['objects']:
              if obj['type'] == 'relationship' and obj.get('relationship_type') == 'uses':
                  source_id = obj.get('source_ref')
                  target_id = obj.get('target_ref')
                  if source_id in apt_groups and target_id in technique_map:
                      technique = technique_map[target_id]
                      apt_groups[source_id]['techniques'].append(technique)
                  if source_id in apt_groups and target_id in software_map:
                      software = software_map[target_id]
                      apt_groups[source_id]['cves'].update(software['cves'])

          print(f"\nFound {len(apt_groups)} APT groups in MITRE ATT&CK\n")

          total_new_ttps = 0
          total_new_cves = 0
          folders_created = 0
          folders_updated = 0

          for group_id, group_data in apt_groups.items():
              group_name = group_data['name']
              techniques = group_data['techniques']
              cves = list(group_data['cves'])
              
              if not techniques and not cves:
                  continue

              folder_name = group_name.replace('/', '-').replace('\\', '-').strip()
              folder_path = Path(folder_name)
              
              if not folder_path.exists():
                  folder_path.mkdir(parents=True, exist_ok=True)
                  folders_created += 1
                  print(f"Created folder: {folder_name}")
              
              md_files = list(folder_path.glob('*.md'))
              for md_file in md_files:
                  try:
                      raw_content = md_file.read_text(encoding='utf-8')
                      if 'mitre' in md_file.name.lower():
                          section_name = 'MITRE ATT&CK TTPs'
                      elif 'autodiscovered' in md_file.name.lower():
                          section_name = 'Auto-discovered TTPs'
                      else:
                          section_name = 'TTPs'
                      cleaned_content = clean_markdown_table(raw_content, folder_name, section_name)
                      if cleaned_content != raw_content:
                          md_file.write_text(cleaned_content, encoding='utf-8')
                          print(f"Cleaned: {md_file.name}")
                  except Exception as e:
                      print(f"Error cleaning {md_file}: {e}")
              
              if techniques:
                  existing_ttps = set()
                  md_files = list(folder_path.glob('*.md'))
                  for md_file in md_files:
                      try:
                          content = md_file.read_text(encoding='utf-8')
                          ttp_matches = re.findall(r'T\d{4}(?:\.\d{3})?', content)
                          existing_ttps.update(ttp_matches)
                      except Exception as e:
                          print(f"Error reading {md_file}: {e}")
                  
                  new_techniques = [t for t in techniques if t['id'] not in existing_ttps]
                  
                  if new_techniques:
                      mitre_md_path = folder_path / 'TTPs-mitre-sync.md'
                      if mitre_md_path.exists():
                          raw_content = mitre_md_path.read_text(encoding='utf-8')
                          existing_content = clean_markdown_table(raw_content, folder_name, 'MITRE ATT&CK TTPs')
                      else:
                          existing_content = f"# {folder_name} - MITRE ATT&CK TTPs\n\n"
                          existing_content += "| Technique | Name | Source | Date |\n"
                          existing_content += "|-----------|------|--------|------|\n"
                      
                      new_rows = []
                      for tech in new_techniques:
                          today = datetime.now().strftime('%Y-%m-%d')
                          row = f"| {tech['id']} | {tech['name']} | MITRE ATT&CK | {today} |"
                          new_rows.append(row)
                      
                      updated_content = existing_content.rstrip() + '\n' + '\n'.join(new_rows) + '\n'
                      mitre_md_path.write_text(updated_content, encoding='utf-8')
                      total_new_ttps += len(new_techniques)
                      folders_updated += 1
                      print(f"{folder_name}: Added {len(new_techniques)} new TTPs")
              
              if cves:
                  cve_json_path = folder_path / 'CVEs.json'
                  existing_cves = set()
                  if cve_json_path.exists():
                      try:
                          cve_data = json.loads(cve_json_path.read_text(encoding='utf-8'))
                          cve_list = cve_data.get('cves', cve_data if isinstance(cve_data, list) else [])
                          for cve_entry in cve_list:
                              cve_id = cve_entry.get('id') or cve_entry.get('cveId') or cve_entry.get('CVE')
                              if cve_id:
                                  existing_cves.add(cve_id)
                      except Exception as e:
                          print(f"Error reading CVEs.json for {folder_name}: {e}")
                  
                  new_cves = [cve for cve in cves if cve not in existing_cves]
                  
                  if new_cves:
                      if cve_json_path.exists():
                          try:
                              cve_data = json.loads(cve_json_path.read_text(encoding='utf-8'))
                          except:
                              cve_data = {'group': folder_name, 'cves': []}
                      else:
                          cve_data = {'group': folder_name, 'cves': []}
                      
                      if 'cves' not in cve_data:
                          cve_data['cves'] = []
                      
                      for cve_id in new_cves:
                          today = datetime.now().strftime('%Y-%m-%d')
                          cve_data['cves'].append({
                              'id': cve_id,
                              'source': 'MITRE ATT&CK',
                              'dateFound': today
                          })
                      
                      cve_json_path.write_text(json.dumps(cve_data, indent=2), encoding='utf-8')
                      total_new_cves += len(new_cves)
                      print(f"{folder_name}: Added {len(new_cves)} new CVEs")

          print("\n" + "=" * 80)
          print("SUMMARY")
          print("=" * 80)
          print(f"Folders created: {folders_created}")
          print(f"Folders updated: {folders_updated}")
          print(f"New TTPs added: {total_new_ttps}")
          print(f"New CVEs added: {total_new_cves}")
          print("=" * 80)

          if folders_created == 0 and total_new_ttps == 0 and total_new_cves == 0:
              print("\nNo new data to sync - everything is up to date!")
              exit(1)
          ENDOFPYTHON

      - name: Commit changes
        if: success()
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add .
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "chore: sync MITRE APT data - $(date +'%Y-%m-%d')"
            git push
          fi
