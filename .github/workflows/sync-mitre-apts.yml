name: Sync MITRE APT Groups

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-mitre-apts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ThreatActors-TTPs repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Fetch MITRE ATT&CK data
        run: |
          curl -o enterprise-attack.json https://raw.githubusercontent.com/mitre/cti/master/enterprise-attack/enterprise-attack.json

      - name: Sync MITRE APT Groups
        run: |
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          import re
          from pathlib import Path
          from datetime import datetime

          # Load MITRE data
          print("[Sync] Loading MITRE ATT&CK data...")
          with open('enterprise-attack.json', 'r') as f:
              mitre_data = json.load(f)

          # Build mappings
          apt_groups = {}
          technique_map = {}
          group_cves = {}

          # Map technique IDs to details
          for obj in mitre_data['objects']:
              if obj['type'] == 'attack-pattern':
                  for ref in obj.get('external_references', []):
                      if ref.get('source_name') == 'mitre-attack':
                          technique_id = ref.get('external_id')
                          if technique_id:
                              technique_map[obj['id']] = {
                                  'id': technique_id,
                                  'name': obj.get('name', ''),
                                  'description': obj.get('description', '')[:100] + '...' if len(obj.get('description', '')) > 100 else obj.get('description', '')
                              }
                              
                              # Extract CVEs from description if present
                              cves_in_desc = re.findall(r'CVE-\d{4}-\d+', obj.get('description', ''))
                              if cves_in_desc:
                                  technique_map[obj['id']]['cves'] = list(set(cves_in_desc))

          # Find APT groups (intrusion-sets)
          for obj in mitre_data['objects']:
              if obj['type'] == 'intrusion-set':
                  group_name = obj.get('name')
                  if group_name:
                      apt_groups[obj['id']] = {
                          'name': group_name,
                          'aliases': obj.get('aliases', []),
                          'techniques': [],
                          'cves': set()
                      }

          # Find relationships: group -> uses -> technique
          for obj in mitre_data['objects']:
              if obj['type'] == 'relationship' and obj.get('relationship_type') == 'uses':
                  source_id = obj.get('source_ref')
                  target_id = obj.get('target_ref')
                  
                  if source_id in apt_groups and target_id in technique_map:
                      technique = technique_map[target_id]
                      apt_groups[source_id]['techniques'].append(technique)
                      
                      # Collect CVEs from this technique
                      if 'cves' in technique:
                          apt_groups[source_id]['cves'].update(technique['cves'])

          print(f"[Sync] Found {len(apt_groups)} APT groups in MITRE")

          # Process each APT group
          total_new_ttps = 0
          total_new_cves = 0
          groups_updated = []

          for group_id, group_data in apt_groups.items():
              group_name = group_data['name']
              techniques = group_data['techniques']
              cves = group_data['cves']
              
              if not techniques and not cves:
                  continue

              # Sanitize folder name
              folder_name = group_name.replace('/', '-').replace('\\', '-').strip()
              folder_path = Path(folder_name)
              
              # Create folder if it doesn't exist
              folder_path.mkdir(exist_ok=True)
              
              # STEP 1: Check existing T-numbers in ALL markdown files
              existing_tnumbers = set()
              for md_file in folder_path.glob('*.md'):
                  with open(md_file, 'r', encoding='utf-8', errors='ignore') as f:
                      content = f.read()
                      # Extract all T-numbers (T1234, T1234.001, etc.)
                      found_tnumbers = re.findall(r'T\d{4}(?:\.\d{3})?', content)
                      existing_tnumbers.update(found_tnumbers)
              
              # STEP 2: Find new techniques not in any markdown
              new_techniques = [t for t in techniques if t['id'] not in existing_tnumbers]
              
              if new_techniques:
                  # Append to TTPs-mitre.md (or create it)
                  mitre_md_path = folder_path / 'TTPs-mitre.md'
                  
                  if mitre_md_path.exists():
                      with open(mitre_md_path, 'r', encoding='utf-8') as f:
                          existing_content = f.read()
                  else:
                      existing_content = f"# {group_name} - MITRE ATT&CK TTPs\n\n"
                      existing_content += "| Technique | Name | Source | Date |\n"
                      existing_content += "|-----------|------|--------|------|\n"
                  
                  # Append new techniques
                  with open(mitre_md_path, 'a', encoding='utf-8') as f:
                      if not existing_content.strip().endswith('|'):
                          f.write('\n')
                      
                      for tech in new_techniques:
                          name = tech['name'][:50]  # Truncate long names
                          f.write(f"| {tech['id']} | {name} | MITRE ATT&CK | {datetime.now().strftime('%Y-%m-%d')} |\n")
                  
                  total_new_ttps += len(new_techniques)
                  print(f"[Sync] {group_name}: Added {len(new_techniques)} new TTPs")
              
              # STEP 3: Update CVEs.json if we have CVEs
              if cves:
                  cve_json_path = folder_path / 'CVEs.json'
                  
                  # Load existing CVEs
                  existing_cves = set()
                  if cve_json_path.exists():
                      with open(cve_json_path, 'r', encoding='utf-8') as f:
                          cve_data = json.load(f)
                          existing_cve_list = cve_data.get('cves', cve_data if isinstance(cve_data, list) else [])
                          for cve_entry in existing_cve_list:
                              cve_id = cve_entry.get('id') or cve_entry.get('cveId') or cve_entry.get('CVE')
                              if cve_id:
                                  existing_cves.add(cve_id)
                  
                  # Find new CVEs
                  new_cves = [cve for cve in cves if cve not in existing_cves]
                  
                  if new_cves:
                      # Load existing structure or create new
                      if cve_json_path.exists():
                          with open(cve_json_path, 'r', encoding='utf-8') as f:
                              cve_data = json.load(f)
                              if 'cves' not in cve_data:
                                  cve_data = {'group': group_name, 'cves': cve_data if isinstance(cve_data, list) else []}
                      else:
                          cve_data = {'group': group_name, 'cves': []}
                      
                      # Append new CVEs
                      for cve_id in new_cves:
                          cve_data['cves'].append({
                              'id': cve_id,
                              'source': 'MITRE ATT&CK',
                              'dateFound': datetime.now().strftime('%Y-%m-%d')
                          })
                      
                      # Write back
                      with open(cve_json_path, 'w', encoding='utf-8') as f:
                          json.dump(cve_data, f, indent=2)
                      
                      total_new_cves += len(new_cves)
                      print(f"[Sync] {group_name}: Added {len(new_cves)} new CVEs")
              
              if new_techniques or (cves and new_cves):
                  groups_updated.append(group_name)

          print(f"\n[Sync] Summary:")
          print(f"  - Groups updated: {len(groups_updated)}")
          print(f"  - New TTPs added: {total_new_ttps}")
          print(f"  - New CVEs added: {total_new_cves}")
          
          if groups_updated:
              print(f"\n[Sync] Updated groups: {', '.join(groups_updated[:10])}" + ("..." if len(groups_updated) > 10 else ""))
          
          PYTHON_SCRIPT

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: sync MITRE APT groups - auto-update TTPs and CVEs"
            git push
            echo "âœ… Changes committed and pushed"
          fi
